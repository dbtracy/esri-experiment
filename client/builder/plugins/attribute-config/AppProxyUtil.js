// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
define(["dojo/_base/array","dojo/Deferred","jimu/portalUtils","esri/dijit/AppProxySettings"],function(k,m,r,t){function n(a){return q.isPremium(a)}function p(a){return q.isSubscriber(a)}function u(a){var b=new m;if(a){a=[].concat(a.operationalLayers,a.baseMap&&a.baseMap.baseMapLayers);var e=[],f={},c;k.forEach(a,function(a){var b,d;a&&a.url&&(b=a.url,d=document.createElement("a"),d.href=b,b=n(d.host),d=p(d.host),b||d)&&(f[a.url]?(c=f[a.url],c.title=c.title+", "+(a.title||a.name)):(c={sourceUrl:a.url,
title:a.title||a.name,premium:b,consumeCredits:d,useProxy:!1},e.push(c),f[a.url]=c))});b.resolve(e)}else b.resolve([]);return b}var q=new t({proxyManagerOptions:{appid:window.appInfo.id}}),h={queryForSecureServicesInMap:function(a,b){try{return r.getPortal(a).getItemData(b).then(function(a){return u(a)},function(){return[]})}catch(e){return a=new m,a.resolve([]),a}},isLimitedProxy:function(a){return a?!isNaN(a.hitsPerInterval)&&!isNaN(a.intervalSeconds)&&0<a.intervalSeconds&&0<a.hitsPerInterval:!1},
findProxy:function(a,b){var e=h.isLimitedProxy(b),f;a=a||[];b=b||{};k.some(a,function(a){if(a.sourceUrl===b.sourceUrl&&!1!==a.proxied&&a.proxyId&&a.proxyUrl){var c=!1;e&&a.hitsPerInterval===b.hitsPerInterval&&a.intervalSeconds===b.intervalSeconds?c=!0:e||h.isLimitedProxy(a)||(c=!0);c&&(f=a);return c}});return f},urlExists:function(a,b){return k.some(a.proxies,function(a){return a.sourceUrl===b&&!1!==a.proxied})},createProxy:function(a,b,e,f){var c,k,g,d=new m,l={};c=n(b);k=p(b);(g=h.findProxy(a.proxies,
{sourceUrl:b,hitsPerInterval:e,intervalSeconds:f}))?(g.premium=c,g.consumeCredits=k,d.resolve(g)):(l.sourceUrl=b,h.isLimitedProxy({hitsPerInterval:e,intervalSeconds:f})&&(l.hitsPerInterval=e,l.intervalSeconds=f),a.createProxies([l]).then(function(a){(g=h.findProxy(a,{sourceUrl:b,hitsPerInterval:e,intervalSeconds:f}))?(g.premium=c,g.consumeCredits=k,d.resolve(g)):d.reject("create proxy failed.")}).otherwise(function(a){d.reject(a)}));return d}};h.isPremium=n;h.consumesCredits=p;return h});